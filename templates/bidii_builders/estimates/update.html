<!-- templates/bidii_builders/estimates/update.html -->
{% extends 'base.html' %}

{% block title %}Update Estimate{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2>Update Estimate #{{ estimate.id }}</h2>
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                <label for="customer" class="form-label">Customer</label>
                <select class="form-control" id="customer" name="customer" required>
                    <option value="">Select Customer</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}" {% if customer.id == estimate.customer.id %}selected{% endif %}>{{ customer.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="property_obj" class="form-label">Property</label>
                <select class="form-control" id="property_obj" name="property_obj" required>
                    <option value="">Select Property</option>
                    {% for property in properties %}
                    <option value="{{ property.id }}" {% if property.id == estimate.property_obj.id %}selected{% endif %}>{{ property.address }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="visit_date" class="form-label">Visit Date</label>
                <input type="date" class="form-control" id="visit_date" name="visit_date" value="{{ estimate.visit_date|date:'Y-m-d' }}" required>
            </div>
            <div class="mb-3">
                <label for="initial_outline" class="form-label">Initial Outline</label>
                <textarea class="form-control" id="initial_outline" name="initial_outline" rows="3" required>{{ estimate.initial_outline }}</textarea>
            </div>
            <div class="mb-3">
                <label for="detailed_estimate" class="form-label">Detailed Estimate</label>
                <textarea class="form-control" id="detailed_estimate" name="detailed_estimate" rows="5" required>{{ estimate.detailed_estimate }}</textarea>
            </div>
            <div class="mb-3">
                <label for="total_cost" class="form-label">Total Cost (KES)</label>
                <input type="number" step="0.01" class="form-control" id="total_cost" name="total_cost" value="{{ estimate.total_cost }}" required>
            </div>
            <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-control" id="status" name="status" required>
                    <option value="pending" {% if estimate.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="sent" {% if estimate.status == 'sent' %}selected{% endif %}>Sent</option>
                    <option value="accepted" {% if estimate.status == 'accepted' %}selected{% endif %}>Accepted</option>
                    <option value="rejected" {% if estimate.status == 'rejected' %}selected{% endif %}>Rejected</option>
                    <option value="in_progress" {% if estimate.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="completed" {% if estimate.status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Update Estimate</button>
            <a href="{% url 'estimate_detail' estimate.id %}" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var customerId = document.getElementById('customer').value;
    var propertySelect = document.getElementById('property_obj');
    
    // Load properties for the initially selected customer
    if (customerId) {
        // Make AJAX request to load properties for selected customer
        fetch(`/api/properties/${customerId}/`)
            .then(response => response.json())
            .then(data => {
                // Clear existing options except the initially selected one
                var selectedPropertyId = propertySelect.value;
                propertySelect.innerHTML = '<option value="">Select Property</option>';
                
                data.forEach(function(property) {
                    var option = document.createElement('option');
                    option.value = property.id;
                    option.textContent = property.address;
                    if (property.id == selectedPropertyId) {
                        option.selected = true;
                    }
                    propertySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    // Add event listener for customer change
    document.getElementById('customer').addEventListener('change', function() {
        var customerId = this.value;
        var propertySelect = document.getElementById('property_obj');
        
        // Clear existing options
        propertySelect.innerHTML = '<option value="">Select Property</option>';
        
        if (customerId) {
            // Make AJAX request to load properties for selected customer
            fetch(`/api/properties/${customerId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        data.forEach(function(property) {
                            var option = document.createElement('option');
                            option.value = property.id;
                            option.textContent = property.address;
                            propertySelect.appendChild(option);
                        });
                    } else {
                        var option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No properties found for this customer';
                        propertySelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    var option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Error loading properties';
                    propertySelect.appendChild(option);
                });
        }
    });
});
</script>
{% endblock %}